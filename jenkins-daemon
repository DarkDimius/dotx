#!/usr/bin/env python
from subprocess import call, Popen, PIPE
import os, sys, re, json, urllib2, traceback

if len(sys.argv) > 1:
  print "usage: " + sys.argv[0]
  sys.exit(1)

with open("/Users/xeno_by/.jenkins", "r") as config:
  jobs = map(lambda job: job.strip(), config.readlines())

new_jobs = []
anything_new = False
for job in jobs:
  if job:
    try:
      failures = Popen(["jenkins-failures", job], stdout=PIPE).communicate()[0].splitlines()
      if failures:
        anything_new = True
        msg = "FAILURE: " + job
        print msg
        call(["growlnotify", "-n", "Jenkins", "-m", msg])
        call(["partest-import", job])
      else:
        new_jobs.append(job)
    except:
      _, value, _ = sys.exc_info()
      print job + ": " + str(value)
      new_jobs.append(job)

if not anything_new:
  print "Nothing new"

with open("/Users/xeno_by/.jenkins", "w") as config:
  config.writelines(map(lambda job: job + "\n", new_jobs))
