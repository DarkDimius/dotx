#!/usr/bin/env python
import os, sys, subprocess, re

if len(sys.argv) != 2:
  print "usage: " + sys.argv[0] + " <fuzzy name or index in .partest>"
  sys.exit(1)

script = subprocess.Popen(["partest-lookup", sys.argv[1]], stdout=subprocess.PIPE)
output = script.communicate()[0][:-1]
if script.returncode != 0:
  print output
  sys.exit(script.returncode)

if output.endswith("/"): output = output[:-1]
root = subprocess.Popen(["scala-root"], stdout=subprocess.PIPE).communicate()[0][:-1]
test = root + "/test/files/" + output
base, ext = os.path.splitext(test)
flavor = os.path.basename(os.path.dirname(base))
checkfile = base + ".check"
logfile = base + "-" + flavor + ".log"

if flavor == "scalacheck":
  for line in open(logfile).readlines():
    if line.startswith("+ "): continue
    print line.strip()
elif flavor == "scalap":
  checkfile = os.path.join(base, "result.test")
  subprocess.call(["bash", "-c", "araxisopendiff " + logfile + " " + checkfile + " &"], stdout=subprocess.PIPE, stderr=subprocess.PIPE)
else:
  if not os.path.exists(checkfile):
    with file(checkfile, 'a'):
      os.utime(checkfile, None)
  # subprocess.call(["bash", "-c", "diffmerge " + logfile + " " + checkfile + " &"], stdout=subprocess.PIPE, stderr=subprocess.PIPE)
  subprocess.call(["bash", "-c", "araxisopendiff " + logfile + " " + checkfile + " &"], stdout=subprocess.PIPE, stderr=subprocess.PIPE)
