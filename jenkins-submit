#!/usr/bin/env python
import subprocess, sys, re, urllib2, traceback, time, json
from subprocess import Popen, call, PIPE

if len(sys.argv) > 1:
  print "usage: " + sys.argv[0]
  sys.exit(1)

introspect = Popen(["hub-introspect"], stdout=PIPE)
lines = introspect.communicate()[0].splitlines()
if introspect.returncode != 0:
  print "".join(lines)
  sys.exit(introspect.returncode)

user, repo, branch, status = lines
if status != "no changes":
  print status
  sys.exit(1)

jenkins_url = "https://scala-webapps.epfl.ch/jenkins/job/scala-checkin-manual/buildWithParameters"
jenkins_url += "?githubUsername=" + user + "&repository=" + repo
jenkins_url += "&branch=" + branch
jenkins_url += "&storeArtifacts=true"
import webbrowser
webbrowser.open(jenkins_url)

time.sleep(2)
try:
  data = urllib2.urlopen("https://scala-webapps.epfl.ch/jenkins/job/scala-checkin-manual/api/json").read()
  data = json.loads(data)
  result = data["lastBuild"]["url"]
  if result:
    status = Popen(["jenkins-track", result], stdout=PIPE).communicate()[0]
    call(["growlnotify", "-n", "Jenkins Submit", "-m", str(status)])
  else:
    call(["growlnotify", "-n", "Jenkins Submit", "-m", "Failed to communicate with the Jenkins API"])
except:
  _, value, _ = sys.exc_info()
  call(["growlnotify", "-n", "Jenkins Submit", "-m", str(value)])
